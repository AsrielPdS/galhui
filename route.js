"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.tryGoTo = exports.goTo = exports.defaultRoute = exports.has = exports.intercept = exports.pop = exports.push = exports.set = exports.add = exports.currentPath = exports.current = exports.root = exports.init = exports.hash = void 0;
const galho_1 = require("galho");
const util_js_1 = require("galho/util.js");
const hash = (s, value) => s.on("click", () => location.hash = value);
exports.hash = hash;
function init(...routeRoot) {
    exports.root = routeRoot;
    window.onhashchange = () => tryGoTo(location.hash);
    exports.current = exports.currentPath = null;
}
exports.init = init;
const routes = {};
function add(key, handler) {
    if ((0, util_js_1.isS)(key))
        routes[key] = handler;
    else
        for (let k in key)
            routes[k] = key[k];
}
exports.add = add;
function set(t) {
    let p = exports.root[0].parent(), i = -1;
    while (p.child(++i).e != exports.root[0].e)
        ;
    for (let e of exports.root)
        e.remove();
    p.place(i, exports.root = t);
}
exports.set = set;
function push(...items) {
    (0, util_js_1.z)(exports.root).putAfter(items);
    exports.root.push(...items);
}
exports.push = push;
function pop(...items) {
    for (let e of items) {
        let index = exports.root.findIndex(t => t.e == e.e);
        if (index != -1) {
            exports.root.splice(index, 1);
        }
        e.remove();
    }
}
exports.pop = pop;
var _intercept, defRoute;
function intercept(v) { _intercept = v; }
exports.intercept = intercept;
function has(path) {
    return path.slice(1).split('/')[0] in routes;
}
exports.has = has;
function defaultRoute(value) { return value === void 0 ? defRoute : defRoute = value; }
exports.defaultRoute = defaultRoute;
async function goTo(path) {
    if (path[0] == '#')
        path = path.slice(1);
    _intercept && (path = (0, util_js_1.def)(_intercept(path), path));
    let keys = path.split('/'), newPath = keys.shift();
    if (newPath != exports.currentPath) {
        exports.current = null;
        let route = routes[newPath];
        if (!route)
            throw 1;
        let dt = (0, util_js_1.isF)(route) ? await route(...keys) : route;
        if (dt && (0, util_js_1.isF)(dt[1])) {
            exports.current = dt[1];
            dt = dt[0];
        }
        exports.currentPath = newPath;
        if (dt)
            set(dt);
    }
    history.replaceState(null, null, "#" + path /*`#${}?${dicToQString(params)}`*/);
    (0, galho_1.getAll)("a.on").do(e => e.c("on", false));
    (0, galho_1.getAll)(`a[href="#${path}"]`).do(e => e.c("on"));
    (0, exports.current)?.(...keys);
}
exports.goTo = goTo;
function tryGoTo(path) {
    return goTo(has(path) ? path : defRoute || "");
}
exports.tryGoTo = tryGoTo;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyb3V0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxpQ0FBa0M7QUFDbEMsMkNBQWlFO0FBRTFELE1BQU0sSUFBSSxHQUFHLENBQUMsQ0FBSSxFQUFFLEtBQVUsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsQ0FBQztBQUF4RSxRQUFBLElBQUksUUFBb0U7QUFDckYsU0FBZ0IsSUFBSSxDQUFDLEdBQUcsU0FBYztJQUNwQyxZQUFJLEdBQUcsU0FBUyxDQUFDO0lBQ2pCLE1BQU0sQ0FBQyxZQUFZLEdBQUcsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNuRCxlQUFPLEdBQUcsbUJBQVcsR0FBRyxJQUFJLENBQUM7QUFDL0IsQ0FBQztBQUpELG9CQUlDO0FBS0QsTUFBTSxNQUFNLEdBQStCLEVBQUUsQ0FBQztBQUc5QyxTQUFnQixHQUFHLENBQUMsR0FBd0IsRUFBRSxPQUFlO0lBQzNELElBQUksSUFBQSxhQUFHLEVBQUMsR0FBRyxDQUFDO1FBQ1YsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE9BQU8sQ0FBQzs7UUFDbkIsS0FBSyxJQUFJLENBQUMsSUFBSSxHQUFHO1lBQ3BCLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdkIsQ0FBQztBQUxELGtCQUtDO0FBRUQsU0FBZ0IsR0FBRyxDQUFDLENBQU07SUFDeEIsSUFBSSxDQUFDLEdBQUcsWUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNqQyxPQUFPLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksWUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFBQyxDQUFDO0lBRXBDLEtBQUssSUFBSSxDQUFDLElBQUksWUFBSTtRQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUMvQixDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxZQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDdkIsQ0FBQztBQU5ELGtCQU1DO0FBQ0QsU0FBZ0IsSUFBSSxDQUFDLEdBQUcsS0FBVTtJQUNoQyxJQUFBLFdBQUMsRUFBQyxZQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDeEIsWUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDO0FBQ3RCLENBQUM7QUFIRCxvQkFHQztBQUNELFNBQWdCLEdBQUcsQ0FBQyxHQUFHLEtBQVU7SUFDL0IsS0FBSyxJQUFJLENBQUMsSUFBSSxLQUFLLEVBQUU7UUFDbkIsSUFBSSxLQUFLLEdBQUcsWUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzVDLElBQUksS0FBSyxJQUFJLENBQUMsQ0FBQyxFQUFFO1lBQ2YsWUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDdkI7UUFDRCxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7S0FDWjtBQUNILENBQUM7QUFSRCxrQkFRQztBQUVELElBQUksVUFBcUIsRUFBRSxRQUFhLENBQUM7QUFDekMsU0FBZ0IsU0FBUyxDQUFDLENBQVksSUFBSSxVQUFVLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUEzRCw4QkFBMkQ7QUFDM0QsU0FBZ0IsR0FBRyxDQUFDLElBQVM7SUFDM0IsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUM7QUFDL0MsQ0FBQztBQUZELGtCQUVDO0FBQ0QsU0FBZ0IsWUFBWSxDQUFDLEtBQVcsSUFBSSxPQUFPLEtBQUssS0FBSyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQztBQUFwRyxvQ0FBb0c7QUFDN0YsS0FBSyxVQUFVLElBQUksQ0FBQyxJQUFZO0lBQ3JDLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUc7UUFDaEIsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFdkIsVUFBVSxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUEsYUFBRyxFQUFNLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ3hELElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUVuRCxJQUFJLE9BQU8sSUFBSSxtQkFBVyxFQUFFO1FBQzFCLGVBQU8sR0FBRyxJQUFJLENBQUM7UUFDZixJQUFJLEtBQUssR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDNUIsSUFBSSxDQUFDLEtBQUs7WUFBRSxNQUFNLENBQUMsQ0FBQztRQUNwQixJQUFJLEVBQUUsR0FBRyxJQUFBLGFBQUcsRUFBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1FBQ25ELElBQUksRUFBRSxJQUFJLElBQUEsYUFBRyxFQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ3BCLGVBQU8sR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEIsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQVEsQ0FBQztTQUNuQjtRQUNELG1CQUFXLEdBQUcsT0FBTyxDQUFDO1FBQ3RCLElBQUksRUFBRTtZQUFFLEdBQUcsQ0FBQyxFQUFTLENBQUMsQ0FBQztLQUN4QjtJQUNELE9BQU8sQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxHQUFHLEdBQUcsSUFBSSxDQUFBLGtDQUFrQyxDQUFDLENBQUM7SUFDL0UsSUFBQSxjQUFNLEVBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUN6QyxJQUFBLGNBQU0sRUFBQyxZQUFZLElBQUksSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ2hELElBQUEsZUFBTyxDQUFBLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO0FBQ3JCLENBQUM7QUF2QkQsb0JBdUJDO0FBQ0QsU0FBZ0IsT0FBTyxDQUFDLElBQVk7SUFDbEMsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFFBQVEsSUFBSSxFQUFFLENBQUMsQ0FBQztBQUNqRCxDQUFDO0FBRkQsMEJBRUMifQ==