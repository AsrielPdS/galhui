"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.tryGoTo = exports.goTo = exports.setDefault = exports.has = exports.intercept = exports.pop = exports.push = exports.set = exports.add = exports.currentPath = exports.current = exports.root = exports.init = exports.hash = void 0;
const galho_1 = require("galho");
const inutil_1 = require("inutil");
const hash = (s, value) => s.on("click", () => location.hash = value);
exports.hash = hash;
function init(...routeRoot) {
    exports.root = routeRoot;
    window.onhashchange = () => {
        tryGoTo(location.hash);
    };
    exports.current = exports.currentPath = null;
}
exports.init = init;
const routes = {};
function add(key, handler) {
    if ((0, inutil_1.isS)(key))
        routes[key] = handler;
    else
        for (let k in key)
            routes[k] = key[k];
}
exports.add = add;
function set(t) {
    let p = exports.root[0].parent(), i = -1;
    while (p.child(++i).e != exports.root[0].e)
        ;
    for (let e of exports.root)
        e.remove();
    p.place(i, exports.root = t);
}
exports.set = set;
function push(...items) {
    (0, inutil_1.z)(exports.root).putAfter(items);
    exports.root.push(...items);
}
exports.push = push;
function pop(...items) {
    for (let e of items) {
        let index = exports.root.findIndex(t => t.e == e.e);
        if (index != -1) {
            exports.root.splice(index, 1);
        }
        e.remove();
    }
}
exports.pop = pop;
var _intercept, defRoute;
function intercept(v) { _intercept = v; }
exports.intercept = intercept;
function has(path) {
    return path.slice(1).split('/')[0] in routes;
}
exports.has = has;
function setDefault(value) { defRoute = value; }
exports.setDefault = setDefault;
async function goTo(path) {
    if (path[0] == '#')
        path = path.slice(1);
    _intercept && (path = (0, inutil_1.def)(_intercept(path), path));
    let keys = path.split('/'), newPath = keys.shift();
    if (newPath != exports.currentPath) {
        exports.current = null;
        let route = routes[newPath];
        let dt = (0, inutil_1.isF)(route) ? await route(...keys) : route;
        if (dt && (0, inutil_1.isF)(dt[1])) {
            exports.current = dt[1];
            dt = dt[0];
        }
        exports.currentPath = newPath;
        if (dt)
            set(dt);
    }
    history.replaceState(null, null, "#" + path /*`#${}?${dicToQString(params)}`*/);
    (0, galho_1.getAll)("a[current]").do(e => e.attr("current", false));
    (0, galho_1.getAll)(`a[href="#${path}"]`).do(e => e.attr("current", true));
    (0, exports.current)?.(...keys);
}
exports.goTo = goTo;
function tryGoTo(path) {
    return goTo(has(path) ? path : defRoute || "");
}
exports.tryGoTo = tryGoTo;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyb3V0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxpQ0FBa0M7QUFDbEMsbUNBQTBDO0FBRW5DLE1BQU0sSUFBSSxHQUFHLENBQUMsQ0FBSSxFQUFFLEtBQVUsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsQ0FBQztBQUF4RSxRQUFBLElBQUksUUFBb0U7QUFDckYsU0FBZ0IsSUFBSSxDQUFDLEdBQUcsU0FBYztJQUNwQyxZQUFJLEdBQUcsU0FBUyxDQUFDO0lBQ2pCLE1BQU0sQ0FBQyxZQUFZLEdBQUcsR0FBRyxFQUFFO1FBQ3pCLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDekIsQ0FBQyxDQUFDO0lBQ0YsZUFBTyxHQUFHLG1CQUFXLEdBQUcsSUFBSSxDQUFDO0FBQy9CLENBQUM7QUFORCxvQkFNQztBQUtELE1BQU0sTUFBTSxHQUErQixFQUFFLENBQUM7QUFHOUMsU0FBZ0IsR0FBRyxDQUFDLEdBQXdCLEVBQUUsT0FBZTtJQUMzRCxJQUFJLElBQUEsWUFBRyxFQUFDLEdBQUcsQ0FBQztRQUNWLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxPQUFPLENBQUM7O1FBQ25CLEtBQUssSUFBSSxDQUFDLElBQUksR0FBRztZQUNwQixNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3ZCLENBQUM7QUFMRCxrQkFLQztBQUVELFNBQWdCLEdBQUcsQ0FBQyxDQUFNO0lBQ3hCLElBQUksQ0FBQyxHQUFHLFlBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDakMsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFD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