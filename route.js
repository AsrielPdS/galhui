import { g, getAll, isE } from "galho";
import { filter, isF, isS, z } from "galho/util.js";
export const hash = (s, value) => s.on("click", () => location.hash = value);
export function init(...routeRoot) {
    root = routeRoot.map(r => r.e);
    window.onhashchange = () => goTo(location.hash);
    current = currentPath = null;
}
var root, current;
export var currentPath;
const routes = {};
export function add(key, handler) {
    if (isS(key))
        routes[key] = handler;
    else
        for (let k in key)
            routes[k] = key[k];
}
export function set(t) {
    let p = g(root[0]).parent, i = -1;
    while (p.child(++i).e != root[0])
        ;
    for (let e of root)
        e.remove();
    p.place(i, root = filter(t).map(v => isE(v) ? v.e : v));
}
export function push(...items) {
    let t = filter(items.map(v => v && (isE(v) ? v.e : v)), v => v && !root.includes(v));
    g(z(root)).after(t);
    root.push(...t);
}
export function pop(...items) {
    for (let e of items) {
        let index = root.findIndex(t => t == e.e);
        if (index != -1) {
            root.splice(index, 1);
        }
        e.remove();
    }
}
// _intercept: Intercept, 
let e = [], defRoute;
export function intercept(v) {
    e.push(v);
}
export function has(path) {
    return path.split('/', 2)[0] in routes;
}
export function defaultRoute(value) { return value === void 0 ? defRoute : defRoute = value; }
export async function goTo(path) {
    if (path[0] == '#')
        path = path.slice(1);
    has(path) || (console.warn(`path '${path}' not found.`), path = defRoute || "");
    let sub = path.split('/'), key = sub.shift();
    let canceled, o = { cancel() { canceled = true; }, sub, path };
    for (let i of e) {
        let t = i(key, o);
        if (canceled)
            return;
        if (t)
            key = (o.sub = sub = (o.path = t).split("/")).shift();
    }
    history.replaceState(null, null, "#" + o.path);
    if (key != currentPath) {
        current = null;
        let route = routes[key];
        if (!route)
            throw 404;
        let dt = isF(route) ? await route(...sub) : route;
        if (dt && isF(dt[1])) {
            current = dt[1];
            dt = dt[0];
        }
        if (dt)
            set(dt);
        currentPath = key;
    }
    updateAnchors();
    current?.(...sub);
}
export function updateAnchors() {
    getAll('a.on[href^="#"]').do(e => e.c("on", false));
    getAll(`a[href="${location.hash}"]`).do(e => e.c("on"));
}
export function hmr() {
    let cp = currentPath;
    currentPath = null;
    try {
        goTo(location.hash);
    }
    catch {
        currentPath = cp;
        console.warn("err parsing current path");
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyb3V0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUssQ0FBQyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsTUFBTSxPQUFPLENBQUM7QUFDMUMsT0FBTyxFQUEwQixNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBTyxDQUFDLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFakYsTUFBTSxDQUFDLE1BQU0sSUFBSSxHQUFHLENBQUMsQ0FBSSxFQUFFLEtBQVUsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsQ0FBQztBQUNyRixNQUFNLFVBQVUsSUFBSSxDQUFDLEdBQUcsU0FBYztJQUNwQyxJQUFJLEdBQUcsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMvQixNQUFNLENBQUMsWUFBWSxHQUFHLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEQsT0FBTyxHQUFHLFdBQVcsR0FBRyxJQUFJLENBQUM7QUFDL0IsQ0FBQztBQU1ELElBQUksSUFBZSxFQUFFLE9BQWUsQ0FBQztBQUNyQyxNQUFNLENBQUMsSUFBSSxXQUFnQixDQUFDO0FBQzVCLE1BQU0sTUFBTSxHQUFXLEVBQUUsQ0FBQztBQUcxQixNQUFNLFVBQVUsR0FBRyxDQUFDLEdBQWlCLEVBQUUsT0FBZTtJQUNwRCxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUM7UUFDVixNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsT0FBTyxDQUFDOztRQUNuQixLQUFLLElBQUksQ0FBQyxJQUFJLEdBQUc7WUFDcEIsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN2QixDQUFDO0FBQ0QsTUFBTSxVQUFVLEdBQUcsQ0FBQyxDQUEwQjtJQUM1QyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNsQyxPQUFPLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztRQUFDLENBQUM7SUFFbEMsS0FBSyxJQUFJLENBQUMsSUFBSSxJQUFJO1FBQ2hCLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUNiLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLElBQUksR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzFELENBQUM7QUFDRCxNQUFNLFVBQVUsSUFBSSxDQUFDLEdBQUcsS0FBOEI7SUFDcEQsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDckYsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNwQixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDbEIsQ0FB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